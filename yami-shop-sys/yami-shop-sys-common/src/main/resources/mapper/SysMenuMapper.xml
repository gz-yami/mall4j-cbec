<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yami.shop.sys.common.dao.SysMenuMapper">

    <resultMap id="sysMenuMap" type="com.yami.shop.sys.common.model.SysMenu">
        <id column="menu_id" property="menuId"/>
        <result column="parent_id" property="parentId"/>
        <result column="url" property="url"/>
        <result column="perms" property="perms"/>
        <result column="type" property="type"/>
        <result column="icon" property="icon"/>
        <result column="order_num" property="orderNum"/>
        <result column="hidden" property="hidden"/>
    </resultMap>
    <resultMap id="shopMenuAndLangMap" type="com.yami.shop.sys.common.model.SysMenu" extends="sysMenuMap">
        <collection property="menuLangList" ofType="com.yami.shop.sys.common.model.SysMenuLang">
            <id column="lang" property="lang"/>
            <result column="menu_id" property="menuId"/>
            <result column="name" property="name"/>
        </collection>
    </resultMap>
    <select id="listMenuIdByRoleId" resultType="java.lang.Long">
        select menu_id from tz_sys_role_menu where role_id = #{roleId}
    </select>
    <sql id="menuParam">
        sm.menu_id,sm.parent_id,sm.url,sm.perms,sm.type,sm.icon,sm.order_num,sm.hidden,sml.*
    </sql>
    <!-- 查询用户的所有菜单 -->
    <select id="listMenuByUserId" resultMap="shopMenuAndLangMap">
        SELECT DISTINCT <include refid="menuParam" />
        FROM tz_sys_user_role ur
        LEFT JOIN tz_sys_role_menu rm ON ur.role_id = rm.role_id
        LEFT JOIN tz_sys_menu sm ON sm.`menu_id` = rm.`menu_id`
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE ur.user_id = #{userId} and sm.type != 2 order by order_num
    </select>
    <!-- 查询所有菜单 -->
    <select id="listMenu" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE sm.type != 2
        ORDER BY sm.order_num
    </select>

    <select id="listSimpleMenuNoButton" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE sm.type != 2
        ORDER BY order_num
    </select>

    <select id="listRootMenu" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        where sm.type = 0
    </select>

    <select id="listChildrenMenuByParentId" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE sm.parent_id = #{parentId}
    </select>

    <select id="listMenuAndBtn" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        ORDER BY sm.order_num
    </select>

    <select id="listMenuNameByPerms" resultMap="shopMenuAndLangMap">
        SELECT sm.menu_id,sml.*
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE sm.menu_id IN (SELECT DISTINCT parent_id FROM tz_sys_menu WHERE perms LIKE CONCAT('%', #{perms}, '%'))
    </select>

    <update id="updateSonMenuState">
        UPDATE tz_sys_menu SET hidden = #{state} WHERE parent_id = #{parentId}
    </update>

    <select id="listMenuPerms" resultType="java.lang.String">
        SELECT perms FROM tz_sys_menu WHERE parent_id = #{parentId} AND type = 2
    </select>

    <select id="listConcealButtonPerms" resultType="java.lang.String">
        SELECT perms FROM tz_sys_menu WHERE hidden = 1
    </select>

    <select id="listRoleMenuAndBtn" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE
        sm.menu_id IN
        (
        SELECT tsm.menu_id FROM tz_sys_role_menu AS rm INNER JOIN tz_sys_menu AS tsm ON rm.menu_id = tsm.menu_id WHERE rm.role_id IN
            (SELECT role_id FROM tz_sys_user AS su INNER JOIN tz_sys_user_role AS ur ON su.user_id = ur.user_id WHERE su.user_id = #{userId})
        )
    </select>

    <select id="getSysMenuById" resultMap="shopMenuAndLangMap">
        SELECT <include refid="menuParam" />
        FROM tz_sys_menu sm
        LEFT JOIN  tz_sys_menu_lang sml ON sm.menu_id = sml.menu_id
        WHERE sm.menu_id = #{menuId}
    </select>
</mapper>

